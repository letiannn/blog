# foc 学习指南

## 1.学习文章

[电机系列(1) - foc 最基本原理、clark 变换 、park 变换、附代码\_foc 代码](https://blog.csdn.net/K_O_R_K/article/details/123546950)

[深入浅出讲解 FOC 算法与 SVPWM 技术](https://zhuanlan.zhihu.com/p/147659820)

[DengFOC 官方文档](https://dengfoc.com/#/dengfoc/灯哥手把手教你写FOC算法/序为什么要出这系列课程.md)

[BLDC 的六步法&PMSM 的 FOC 法综合\_bldc 和 pmsm 电机的驱动电路](https://blog.csdn.net/Staokgo/article/details/122128590)

[FOC 电流采样方案对比 单电阻/双电阻/三电阻](https://www.cnblogs.com/unclemac/p/12783352.html#4__32)

[从理论到硬件：SVPWM 和 FOC 上手教程](https://zhuanlan.zhihu.com/p/653313547)

[BLDC 与 PMSM 的基本驱动原理及六部换相与 FOC 控制精讲](https://blog.csdn.net/yck1716/article/details/136143289)

## 2.无刷电机的基本工作方式

- 驱动原理

![img](.\foc.assets\v2-25a37687036a332e0709e3f475d2be48_1440w.jpg)

- 换向的电流图

![img](.\foc.assets\37d5e8669a1dee9f7cc167c3d9ce4f1d.gif)

- 磁力的矢量图

![img](.\foc.assets\9fdb0f80003b477205b87470be89660d.gif)

## 3.无刷控制方式

目前,主流的无刷直流电机的控制方式有 2 种：

- 方波控制 (也称为梯形波控制,120° 控制,6 步换向控制);
- FOC (又称为矢量变频,磁场矢量定向控制);

## 4.BLDC 和 PMSM 的区别

- BLDC 和 PMSM 在本质上几乎是同一种电机(永磁同步电机),但“BLDC”通常特指一种反电动势为梯形波的设计,而“PMSM”特指反电动势为正弦波的设计.不同的反电动势波形,最适合用不同的控制方法来获得最佳性能.​

- 为什么通常 bldc 使用六步换向而 pmsm 使用 foc 呢?
  答:反电动势的波形(uvw 接示波器,扭动电机,形成磁生电的电动势)实际上是我们需要去驱动电机的最优波形,所以 bldc 的反电动势设计为梯形波,而 pmsm 设置为正弦波,目的就是需要我们使用六步换向去驱动 bldc 和 foc 去驱动 pmsm.

### 反电动势图

![img](.\foc.assets\v2-f905202c0c4ebf9da40f84ff856564b8_1440w.png)

### 区别框图

| 特性             | BLDC + 六步换向      | PMSM + FOC                               |
| ---------------- | -------------------- | ---------------------------------------- |
| **反电动势波形** | 梯形波               | 正弦波                                   |
| **相电流波形**   | 方波(目标)           | 正弦波(目标)                             |
| **控制复杂度**   | 低                   | 高                                       |
| **处理器要求**   | 低端 MCU             | 高端 MCU/DSP                             |
| **成本**         | 低                   | 高                                       |
| **转矩性能**     | 有脉动,不够平滑      | 极其平滑,无脉动                          |
| **噪音/振动**    | 较大                 | 非常小                                   |
| **效率**         | 较高,但低速效率较低  | 高,全速度范围效率优                      |
| **典型应用**     | 风扇、工具、航模电机 | 电动汽车驱动、伺服系统、变频家电、机器人 |

### 方波控制

方波控制使用霍尔传感器或者无感估算算法获得电机转子的位置,然后根据转子的位置在 360° 的电气周期内,进行 6 次换向(每 60° 换向一次).每个换向位置电机输出特定方向的力,因此可以说方波控制的位置精度是电气 60°.由于在这种方式控制下,电机的相电流波形接近方波,所以称为方波控制.
优点:控制算法简单,硬件成本较低,使用性能普通的控制器便能获得较高的电机转速;
缺点:转矩波动大,有明显齿轮感,存在一定的电流噪声,效率达不到最大值.方波控制适用于对电机转动性能要求不高的场合.

![img](.\foc.assets\v2-c20243476eef80b5f225764ef69f9894_1440w.jpg)

![img](.\foc.assets\53bc93439de7730c92a43bf5b1664b07.gif)

![img](.\foc.assets\67373548b22be981763aa7e3b5202b17.gif)

### FOC 控制

正弦波控制实现了电压矢量的控制,间接实现了电流大小的控制,但是无法控制电流的方向.FOC 控制方式可以认为是方波控制的升级版本,无限步的换向的控制,实现了电流矢量的控制,也即实现了电机定子磁场的矢量控制.
优点：转矩波动小、效率高、噪声小、动态响应快;
缺点：硬件成本较高、对控制器性能有较高要求,电机参数需匹配.

#### 输入输出数据

输入采集数据

| 数据名称                | 描述                                | 采集方式 / 传感器                                                                                                                                                                                                                                                                      | 备注                                                                                                             |
| ----------------------- | ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| **三相电流**            | 电机三相绕组中至少两相的瞬时电流值. | **1. 采样电阻 + 运算放大器：** 在逆变桥的下桥臂或电机相线中串联精密采样电阻,测量其电压降并通过运放放大. <br />**2. 霍尔电流传感器：** 如 ACS712 等芯片,通过霍尔效应非接触式测量电流,隔离性好,精度高. <br />**3. 隔离式电流传感器：** 基于霍尔原理的闭环传感器,性能优异,用于大功率场合. | 第三相电流 `I_c`可通过 `I_a + I_b + I_c = 0`计算得出.通常需要 ADC 模块在特定时刻(如 PWM 中心对齐点)进行同步采样. |
| **转子位置角度 (θ)**    | 电机转子的绝对磁极位置(0-360°).     | **1. 编码器：** <br />**增量式编码器**：通过 A/B/Z 脉冲信号计算相对位置和速度,成本低. <br />**绝对式编码器**：如 AS5048B,直接输出绝对位置码值,精度高,抗干扰强. <br />**2. 无传感器算法估算**： 通过检测电机反电动势或高频注入等算法实时估算转子位置,节省成本和空间.                    | 这是 FOC 实现坐标变换的关键.有传感器方案精度高、低速性能好；无传感器方案简化系统结构.                            |
| **直流母线电压 (可选)** | 驱动逆变桥的电源电压.               | **电阻分压电路 + ADC 采样：** 使用高精度电阻将母线电压分压到 MCU 的 ADC 可测量范围(如 0-3.3V).                                                                                                                                                                                         | 用于 SVPWM 算法计算电压矢量利用率以及过压/欠压保护.                                                              |
| **电机温度(可选)**      | 电机绕组或外壳的温度.               | **负温度系数热敏电阻 (NTC)**： 电阻值随温度变化,通过分压电路 ADC 采样. **温度传感器芯片**： 如 PT100, DS18B20 等,直接数字输出.                                                                                                                                                         | 用于实现过热降载或保护,防止电机和驱动器损坏.                                                                     |

输出数据

| 输出名称               | 描述                                           | 输出方式 / 作用                                                                                                                                                                                                                                                                                                                     | 备注                                                                    |
| ---------------------- | ---------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- |
| **六路 PWM 信号**      | 驱动三相逆变桥(6 个开关管)的脉冲宽度调制信号.  | **MCU 的定时器 PWM 输出通道**： <br />直接生成 6 路带死区控制的互补 PWM 波,通过预驱芯片如(IR21xx,lks560)放大后控制功率管(MOSFET/IGBT)的导通与关断.<br />或者如(**drv/ms/at8313**)内部集成功率管,直接输出三相交流电.                                                                                                                 | 这是最核心的输出,SVPWM 算法的最终物理实现.死区时间防止上下桥臂直通短路. |
| **内部状态数据(可选)** | FOC 算法计算出的关键内部变量,用于监控系统状态. | **串口 (UART/SCI)、CAN 总线、SPI、I2C 等**： 将数据发送到上位机(PC)、显示屏或其他控制器.<br />常见数据包括：<br />`I_d`, `I_q`： 励磁和转矩电流.<br />`V_d`, `V_q`： PI 控制器输出的电压值.<br />**速度/位置**： 计算或估算出的电机速度和位置. <br />**目标转矩/功率**： 系统的控制目标. <br />**故障代码**： 如过流、过压、过热等. | 这些数据对于**系统调试、性能优化和状态监控**至关重要.                   |
| **控制信号(可选)**     | 用于控制外部设备的信号.                        | **通用输入输出口 (GPIO)**： - **继电器/接触器控制**： 控制主回路通断. - **风扇控制**： 输出 PWM 信号控制散热风扇转速. - **指示灯**： 指示运行状态或故障.                                                                                                                                                                            | 实现完整的系统功能管理.                                                 |

#### FOC 控制流程的五个核心阶段

**foc 整体设计的基本框图**

![foc基本设计框图](.\foc.assets\b02288d105e350dc11128e9b1d4bc9c9.png)

1. **测量与采样 (Measurement & Sampling)**
   - **作用**：**获取系统当前的实时物理量**,这是整个控制闭环的基础.主要包括：
     - **相电流采样**：使用电流传感器测量电机三相绕组中至少两相的电流(如 `I_a`和 `I_b`),第三相电流可通过基尔霍夫电流定律计算得出(因为 `I_a + I_b + I_c = 0`).
     - **转子位置采样**：使用编码器、旋转变压器等位置传感器获取转子的绝对位置角度(θ).对于无传感器 FOC,该角度由算法估算得出.
     - **速度值计算**：通过对位置角度进行微分或计算,或其他方式,得到转子的实时速度.
2. **坐标变换 (Coordinate Transformation)**
   - **作用**：**将测量的自然三相交流值转换到便于控制的直流坐标系下**,解耦,这是实现“磁场定向”或称“矢量”控制的关键数学工具.主要包括两个变换：
     - **Clarke 变换 3/2 变换**：作用是将三相静止坐标系(a, b, c)下的电流 `(I_a, I_b, I_c)`转换为两相静止坐标系(α, β)下的正交电流 `(I_α, I_β)`.它简化了系统模型,将三个变量减少为两个变量.

![动图](.\foc.assets\v2-ff5afdc50c24035aba4ccca8929b870f_b.webp)

![动图](.\foc.assets\v2-9bd41492d86330d899d4a0f597d390de_b.webp)

- **Park 变换**：非线性->线性,作用是将两相静止坐标系`(α, β)`下的电流 `(I_α, I_β)`转换为随转子磁场同步旋转的坐标系`(d, q)`下的直流电流 `(I_d, I_q)`.**经过此变换,代表磁场分量的 `I_d`和代表转矩分量的 `I_q`从交流量变成了直流量**,从而可以像控制直流电机一样进行精确控制.

![](.\foc.assets\4c314f317b1f9783d2ff0dd3e7866f1e.gif)

1. **PI 调节控制 (PI Regulation Control)**

   - **作用**：**对转换后的直流分量进行精确闭环调节,使其快速、稳定地跟踪目标值**.这是控制系统的“大脑”.

     - **转矩控制**：将变换得到的 `I_q`与其给定值 `I_q*`(通常来自外部的速度环输出)进行比较,误差送入 PI 控制器,输出用于控制转矩的电压分量 `V_q`.
     - **磁场控制**：将变换得到的 `I_d`与其给定值 `I_d*`(对于大多数永磁电机,通常设为 0,即不做额外增磁或弱磁)进行比较,误差送入另一个 PI 控制器,输出电压分量 `V_d`.

     ![](.\foc.assets\4b9265f00b531b6bf417212b7d7c728b.jpeg)

2. **逆坐标变换 (Inverse Coordinate Transformation)**

   - **作用**：**将控制器的直流输出电压命令,重新转换回电机自然坐标系所能理解的交流电压命令**.它是阶段 2 的逆过程.
     - **Park 变换**：作用是将旋转坐标系(d, q)下 PI 控制器输出的直流电压命令 `(V_d, V_q)`,利用转子角度(θ)逆变换回两相静止坐标系(α, β)下的交流电压命令 `(V_α, V_β)`.
     - (注：Clarke 逆变换在此流程中通常被后续的 SVPWM 模块所替代,无需显式进行).

3. **调制与输出 (Modulation & Output)**

   - **作用**：**将逆变换得到的电压矢量命令,转化为实际可以驱动功率开关管的 PWM 信号,最终在电机绕组上生成所需的三相正弦电流**.这是控制算法的最终执行环节.
     - **空间矢量脉宽调制 (SVPWM)**：SVPWM 算法接收电压矢量 `(V_α, V_β)`,通过计算确定如何控制三相逆变桥的六个开关管(MOSFET/IGBT)的导通和关断时间,以最有效率的方式合成出该目标电压矢量.
     - **驱动输出**：将 SVPWM 模块生成的六路 PWM 信号(含死区时间控制)输出到驱动芯片,最终驱动三相逆变桥,从而控制电机运行.

整个流程从阶段 1 到阶段 5 循环往复,形成一个高速、高精度的闭环控制系统,最终实现电机转矩的平滑、高效控制.

![img](.\foc.assets\fe0109b648090885920891ea96c0db7d.gif)

![img](.\foc.assets\4d4e9077f76ffcbd54d838e0aaab0362.png)
